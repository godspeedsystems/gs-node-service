# config, inputs, ouputs, vars
# Environment variables will be loaded in config files via some convention
summary: Multiplexing create loan for hdfc api calls
tasks:
    - id: step1 # the response of this will be accessible within the parent step key, under the step1 sub key
      description: create account in the bank
      fn: com.gs.http
      args:
        datasource: growthsource
        params:
        data:
            #partner_application_id: PSAM-2022
            partner_application_id: ${'PSAM-' + randomString(5, '0123456789')}
            mobile_number: "9823123318"
            personal_email_id: ${std.get(inputs.body, 'sambasiva', 'shane.raew3@growthsourceft.com')}
            customer_consent: true
            gender: ${std.get(mappings.Gender, inputs.body.gender)}
            date_of_birth: "21-06-1991"
            pan_number: "AZOPB8813Y"
            customer_name: "shane belgal"

        # data: |
        #   <transform>
        #     {
        #       partner_application_id: 'PSAM-' + randomString(5, '0123456789'),
        #       mobile_number: "9823123318",
        #       personal_email_id: std.get(inputs.body, 'sambasiva', 'shane.raew3@growthsourceft.com'),
        #       customer_consent: true,
        #       gender: if randomInt(0, 1) == 1 then 'M' else 'F',
        #       date_of_birth: "21-06-1991",
        #       pan_number: "AZOPB8813Y",
        #       customer_name: "shane belgal"
        #     }
        #   </transform>
        #data: ${inputs.body}
        config:
          url : /loki/v1/application/
          method: post

      retry: #Kestra spec compliant retry mechanism. By default turned off.
        maxAttempt: 5
        type: constant
        interval: PT15M

      on_error:
        continue: true

    - id: step2
      fn: com.gs.transform
      args: |
          if outputs.step1.data['response_code'] == 'S001' then {
              code: 200,
              success : true,
              data: {
                  application_id: outputs.step1.data['response_data']['application_id']
              },
              message: ''
          } else {
              code: outputs.step1.code,
              success : false,
              data: {
                lender_response_code: outputs.step1.data['response_code']
              },
              message:  outputs.step1.data['response_string']
          }